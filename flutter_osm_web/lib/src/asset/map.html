<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin></script>
    <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    #mapid {
      width: 100%;
      height: 100%;
    }
    

    </style>
</head>

<body id="frame_body_map" style="margin:0px;">
<div id="mapid"></div>
<div id="render-icon" style="display:none;">
</div>
<script>



    var zoom = 2.0;
    var stepZoom = 1.0;
    var defaultIcon = "";
    var staticIcons = new Map();
    var staticGeoPoint = new Map();
    var dynamicIcon = "";
    var homeMarker;


    var mymap = L.map('mapid', {
      renderer: L.canvas(), 
      zoomControl : false,
    });
    var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Leaflet | Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
      minZoom: 2,
      tileSize: 256,
    });
    OpenStreetMap_Mapnik.addTo(mymap);
    mymap.setView([0, 0], 2);

  async function initMapLocation(point) {
       console.log("zoom init map :"+zoom);
       mymap.setView([point.lat, point.lon],zoom);
       isMapReady(true);
  }

   async function userLocation() {
      getMyLocation().then((user)=>{
         mymap.flyTo([user.lat, user.lon],mymap.getZoom());
      });
     
    
      return 200;
    
  }

  async function getMyLocation() {
      var position = await new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject({error: true, message: 'Geolocation is not supported by your browser' });
        } else {
          navigator.geolocation.getCurrentPosition(
            resolve,
            (position) => {
              reject({error: true, message: 'Unable to retrieve your location' });
            }
          );
        }
      });
      const latitude = position.coords.latitude;
      const longitude = position.coords.longitude;

      return {
        lat : latitude,
        lon : longitude
      };
  }

  async function changePosition(point,showMarker,animate) {
       const position = [point.lat, point.lon];
       if(showMarker){
         var args = {}
          if(defaultIcon!=""){
            args = {
              icon:L.icon(
                  { 
                    iconUrl : "data:image/png;base64,"+defaultIcon,
                    iconSize : [32,32]
                  }
                )
              }
          }
          setHomeMarker(point,args);
       }
       if(!animate){
         mymap.setView(position,mymap.getZoom());
       }else{
          mymap.flyTo(position,mymap.getZoom());
       }
       return 200;
  }
  
  async function removeMarker(point){
    mymap.eachLayer(function(layer){
       if(layer instanceof L.Marker) {
         const latlng = layer.getLatLng()
        if(latlng.lat == point.lat && latlng.lng == point.lon) {
          mymap.removeLayer(layer);
        }
    }
    });
  }
    
  async function setDefaultIcon(icon) {
        defaultIcon = icon;
        return 200;
  }

  async function setStaticGeoPointIcon(id,icon) {
        staticIcons.set(id,icon)
        return 200;
  }

  async function setStaticGeoPoint(id,points) {
        var markers = [];
        if(staticGeoPoint.has(id)){
            staticGeoPoint[id].clearLayers();
        }
        var icon = L.icon(
              { 
                iconUrl : "data:image/png;base64,"+staticIcons.get(id),
                iconSize : [32,32]
              }
            )
        points.forEach(function(ele){
            markers.push(L.marker([ele.lat, ele.lon],{icon:icon})
            .addTo(mymap)
            .on("click", function(event){
                  const geoP = event.latlng;
                  onGeoPointClicked(geoP.lng,geoP.lat)
            }))
        })
        const groupLayer = L.layerGroup(markers).addTo(mymap);
        staticGeoPoint.set(id,groupLayer);

        return 200;
  }
    
  async function configInitZoomMap(step,initZoom,minZoomLevel,maxZoomLevel){
      mymap.setMinZoom(minZoomLevel);
      mymap.setMaxZoom(maxZoomLevel);
      zoom = initZoom;
      stepZoom = step;
      return 200;
  }

  async function setZoomStep(zoomStep) {
        stepZoom = zoomStep
        return 200;
  }
  async function zoomIn() {
      mymap.zoomIn(stepZoom);
      return 200;
  }
  async function zoomOut() {
        mymap.zoomOut(stepZoom);
      return 200;
  }
  async function setZoom(zoom) {
      var nzoomlevel = zoom;
      if(nzoomlevel >= mymap.getMinZoom() && nzoomlevel <= mymap.getMaxZoom()){
        mymap.setZoom(nzoomlevel);
      }
      return 200;
  }
  async function setZoomWithStep(step){
      var nzoomlevel = mymap.getZoom() + step;
      if(nzoomlevel >= mymap.getMinZoom() && nzoomlevel <= mymap.getMaxZoom()){
        mymap.setZoom(nzoomlevel);
      }else{
        if(nzoomlevel > mymap.getMaxZoom()){
          mymap.setZoom(mymap.getMaxZoom());
        }else if(nzoomlevel < mymap.getMinZoom()){
          mymap.setZoom(mymap.getMinZoom());
        }
      }
      return 200;
  }
  async function getZoom(){
    return mymap.getZoom();
  }
  async function setMaxZoomLevel(zoomLevel){
      mymap.setMaxZoom(zoomLevel);
  }
  async function setMinZoomLevel(zoomLevel){
      mymap.setMinZoom(zoomLevel);
  }


  function setHomeMarker(point,args){
      if(homeMarker == undefined){
        homeMarker = L.marker([point.lat, point.lon],args).addTo(mymap);

      }else{
        homeMarker.setLatLng([point.lat, point.lon]);
      }
  }

 


  
</script>


</body>

</html>